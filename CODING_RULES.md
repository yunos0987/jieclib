<a id="coding-rules"></a>
# コーディング規約

## 目次
1. [目的](#目的)
2. [コーディングスタイル](#コーディングスタイル)
3. [命名規則](#命名規則)
4. [フォーマット](#フォーマット)
5. [エラーハンドリング](#エラーハンドリング)
6. [テスト](#テスト)
7. [ドキュメント](#ドキュメント)
8. [依存関係](#依存関係)
9. [バージョン管理](#バージョン管理)

## 目的

このコーディング規約は、JiecLibプロジェクトにおけるIEC 61131-3 ST言語コードの品質と一貫性を保つために定められています。

- コードの可読性と保守性の向上
- チーム開発における統一されたコーディングスタイルの確立
- 各社プログラミングツールとの互換性の確保
- 生成AIとの協調開発における効率性の向上
- テスト駆動開発（TDD）による品質保証

## コーディングスタイル

- continue構文を使用しないこと。
	- オムロン環境が未サポートのため。
- 多次元配列の初期値は、1次元フラットで要素数だけ合わせて記述します。
```
var a: array[0..1, 0..2] of dint := [16#00, 16#01, 16#02. 16#10, 16#11, 16#12];
```
- 可変長配列（e.g. array[\*] of lreal）は、var_in_out引数でのみ使用すること。
- ファンクションの戻り値に構造体型を使用しないこと。構造体データを結果として得る必要がある場合、var_in_outを使用する。
	- オムロン環境が未サポートのため。
- 論理式における or や and のオペランドが式の場合、括弧で括る。
```
if ((i = 0) and (j = 0)) or first_time then
	...
end_if;
```
- 一行で書くことができる注釈は、// ～ を使用する。複数行の注釈は、(\* ～ \*) を使用する。/\* ～ \*/を使用しない。
- 異常系の実装においては、enoをfalseに設定してそのPOUを終える。その際、戻り値を設定する必要はない。
```
if ＜異常＞ then
	eno := false;
	return;
end_if;
```
- 統計ライブラリ（/statsディレクトリ以下）において、内部で可変のwork領域が必要であれば、var_in_outで呼び出し元で用意する。このとき、当該引数変数名の接尾に_workを付加する。ただし、既にworkであれば付加しなくて良い。
- 統計ライブラリ（/statsディレクトリ以下）において、`Array_isRegular`でない配列を異常として扱う。
- 線形代数ライブラリ（/linalgディレクトリ以下）において、ベクトルや行列の基底の型は、lreal型とする。

## 命名規則

- `p\_`, `P\_`で始まる名前で定義することを禁止する。
	- オムロン環境が禁止しているため。

## フォーマット

- インデントにはタブ文字を使用する。スペース文字によるインデントは使用しない。
- エディタのタブ幅設定は4文字とする。
* コード部は、`{st}` ~ `{end}`で括ります。defineマクロ内では、エスケープして、`\${sd\$}` ~ `\${end\$}`と記述します。

## エラーハンドリング

- すべてのファンクション・ファンクションブロックは、`eno`（Enable Output）パラメータを使用してエラー状態を通知する。
- エラー発生時は`eno := false`を設定し、`return`で処理を終了する。
- 入力パラメータの妥当性検証（配列の正規性チェック、範囲チェックなど）を実装する。
- 統計ライブラリにおいては、数値計算の特異点（ゼロ除算、負の数の平方根など）に対する適切な処理を実装する。

## テスト

- 統計ライブラリ（/test/statsディレクトリ以下）におけるp値の検証は、EXPECT_NEARを使用することを基本とし、abs_errorを1.0e-4以下とする。

## ドキュメント

- （生成AI）POUの先頭にdocプラグマを記述すること。
```
(*{doc 主要な統計量を得る。
平均、分散、歪度、尖度を得る。
@inout data サンプルデータを含む配列。
	正規配列（次元の始点が0で要素数1以上）でなければいけない。
@input n dataの先頭n個を使用する。
	-1を指定するとき、dataの全要素を使用する。
	デフォルト値: -1
@output mean 平均（算術平均）。
@output variance 分散。
@output skewness 歪度。
@output kurtosis 尖度。
@return 実際に計算に使用した配列の要素数。
@error dataが正規配列でない場合。}*)
function Stats_statistics_value: dint
	_PROLOGUE_OF_FUNCTION_()
	var_in_out
		(*{doc サンプルデータを含む配列。}*)
		data: array[*] of lreal;
	end
	var_input
		(*{doc dataの先頭n個を使用する。}*)
		n: dint := -1;
	end
	var_output
	(*{doc 平均（算術平均）。}*)
	mean: lreal;
	(*{doc 分散。}*)
	variance: lreal;
	(*{doc 歪度。}*)
	skewness: lreal;
	(*{doc 尖度。}*)
	kurtosis: lreal;
	end
	:
end
```

## 依存関係

- JiecUnitテストフレームワークへの依存は、テストコードのみに限定する。
- `{#include}`プリプロセッサ指令を使用してモジュール間の依存関係を明確にする。

## バージョン管理

- Gitを使用してソースコードを管理する。
- `main`ブランチは常にビルド可能で、テストが通る状態を維持する。
- タグを使用してリリースバージョンを管理する（例：v1.0.0）。
- `.gitignore`ファイルを適切に設定し、生成ファイル（*.xml、__pycache__など）をリポジトリに含めない。
