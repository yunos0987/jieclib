(*
 * $ cd <JiecLib Project Root>
 * $ jiecc ./test/stats/regression/test_linear_regression.txt -I. -I./vendor/jiecunit/sys -I./vendor/jiecunit -D_TEST_ -o ./test/stats/regression/test_linear_regression.xml -t omron
 *)
{#include <jiecunit.txt>}
{#include <stats/regression/linear_regression.txt>}

{#ifdef _TEST_}
DEFINE_CONFIGURATION(
	_JIEC_TESTNAMES_LIST_(
		'test_stats_linear_regression_normal'
	)
)
{#endif}

{#define EPS 1.0e-9}

TEST_S(test_stats_linear_regression_normal)
	var
		x_1: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		y_1: array[0..4] of lreal := [2.0, 4.0, 6.0, 8.0, 10.0];
		x_2: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		y_2: array[0..4] of lreal := [3.0, 5.0, 7.0, 9.0, 11.0];
		x_3: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		y_3: array[0..4] of lreal := [6.0, 7.0, 8.0, 9.0, 10.0];
		x_4: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		y_4: array[0..4] of lreal := [3.0, 6.0, 9.0, 12.0, 15.0];
		x_5: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		y_5: array[0..4] of lreal := [2.5, 3.0, 3.5, 4.0, 4.5];
		x_6: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		y_6: array[0..4] of lreal := [10.0, 8.0, 6.0, 4.0, 2.0];
		x_7: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		y_7: array[0..4] of lreal := [5.0, 5.0, 5.0, 5.0, 5.0];
		x_8: array[0..4] of lreal := [0.0, 1.0, 2.0, 3.0, 4.0];
		y_8: array[0..4] of lreal := [1.0, 1.5, 2.0, 2.5, 3.0];
		x_9: array[0..5] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0, 6.0];
		y_9: array[0..5] of lreal := [2.0, 4.0, 6.0, 8.0, 10.0, 12.0];
		x_10: array[0..1] of lreal := [1.0, 2.0];
		y_10: array[0..1] of lreal := [1.0, 3.0];
		x_n1: array[0..5] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0, 6.0];
		y_n1: array[0..5] of lreal := [2.1, 3.9, 6.2, 7.8, 10.1, 11.9];
		x_n2: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		y_n2: array[0..4] of lreal := [6.1, 7.0, 7.9, 9.1, 10.0];
		x_short: array[0..0] of lreal := [1.0];
		y_short: array[0..0] of lreal := [1.0];
		x_mismatch: array[0..2] of lreal := [1.0, 2.0, 3.0];
		y_mismatch: array[0..1] of lreal := [1.0, 2.0];
		result_1, result_2, result_3, result_4, result_5, result_6, result_7, result_8: Stats_LinearRegressionResult;
		result_9, result_10, result_n1, result_n2, result_short, result_mismatch: Stats_LinearRegressionResult;
		result_eno: bool;
	end
	{st}
		// Perfect positive linear relationship: y = 2*x
		Stats_linear_regression(x:=x_1, y:=y_1, result:=result_1);
		EXPECT_NEAR(2.0, result_1.slope, EPS);
		EXPECT_NEAR(0.0, result_1.intercept, EPS);
		EXPECT_NEAR(1.0, result_1.r_squared, EPS);

		// Positive linear with positive intercept: y = 2*x + 1
		Stats_linear_regression(x:=x_2, y:=y_2, result:=result_2);
		EXPECT_NEAR(2.0, result_2.slope, EPS);
		EXPECT_NEAR(1.0, result_2.intercept, EPS);
		EXPECT_NEAR(1.0, result_2.r_squared, EPS);

		// Slope 1 with intercept 5: y = x + 5
		Stats_linear_regression(x:=x_3, y:=y_3, result:=result_3);
		EXPECT_NEAR(1.0, result_3.slope, EPS);
		EXPECT_NEAR(5.0, result_3.intercept, EPS);
		EXPECT_NEAR(1.0, result_3.r_squared, EPS);

		// Slope 3 with zero intercept: y = 3*x
		Stats_linear_regression(x:=x_4, y:=y_4, result:=result_4);
		EXPECT_NEAR(3.0, result_4.slope, EPS);
		EXPECT_NEAR(0.0, result_4.intercept, EPS);
		EXPECT_NEAR(1.0, result_4.r_squared, EPS);

		// Slope 0.5: y = 0.5*x + 2
		Stats_linear_regression(x:=x_5, y:=y_5, result:=result_5);
		EXPECT_NEAR(0.5, result_5.slope, EPS);
		EXPECT_NEAR(2.0, result_5.intercept, EPS);
		EXPECT_NEAR(1.0, result_5.r_squared, EPS);

		// Negative slope -2: y = -2*x + 12
		Stats_linear_regression(x:=x_6, y:=y_6, result:=result_6);
		EXPECT_NEAR(-2.0, result_6.slope, EPS);
		EXPECT_NEAR(12.0, result_6.intercept, EPS);
		EXPECT_NEAR(1.0, result_6.r_squared, EPS);

		// Horizontal line (zero slope): y = 5
		Stats_linear_regression(x:=x_7, y:=y_7, result:=result_7);
		EXPECT_NEAR(0.0, result_7.slope, EPS);
		EXPECT_NEAR(5.0, result_7.intercept, EPS);

		// Offset zero: y = 0.5*x + 1
		Stats_linear_regression(x:=x_8, y:=y_8, result:=result_8);
		EXPECT_NEAR(0.5, result_8.slope, EPS);
		EXPECT_NEAR(1.0, result_8.intercept, EPS);
		EXPECT_NEAR(1.0, result_8.r_squared, EPS);

		// Large array (6 points): y = 2*x
		Stats_linear_regression(x:=x_9, y:=y_9, result:=result_9);
		EXPECT_NEAR(2.0, result_9.slope, EPS);
		EXPECT_NEAR(0.0, result_9.intercept, EPS);
		EXPECT_NEAR(1.0, result_9.r_squared, EPS);

		// Minimum size (2 points): y = 2*x - 1
		Stats_linear_regression(x:=x_10, y:=y_10, result:=result_10);
		EXPECT_NEAR(2.0, result_10.slope, EPS);
		EXPECT_NEAR(-1.0, result_10.intercept, EPS);
		EXPECT_NEAR(1.0, result_10.r_squared, EPS);

		// Noisy data (6 points)
		Stats_linear_regression(x:=x_n1, y:=y_n1, result:=result_n1);
		EXPECT_NEAR(1.977142857143, result_n1.slope, 0.0001);
		EXPECT_NEAR(0.080000000000, result_n1.intercept, 0.01);
		EXPECT_NEAR(0.998382119923, result_n1.r_squared, 0.0001);

		// Noisy data (5 points)
		Stats_linear_regression(x:=x_n2, y:=y_n2, result:=result_n2);
		EXPECT_NEAR(0.990000000000, result_n2.slope, 0.0001);
		EXPECT_NEAR(5.050000000000, result_n2.intercept, 0.01);
		EXPECT_NEAR(0.997252747253, result_n2.r_squared, 0.0001);

		// Failure case: array size < 2
		Stats_linear_regression(x:=x_short, y:=y_short, result:=result_short, eno=>result_eno);
		EXPECT_FALSE(result_eno);

		// Failure case: array size mismatch
		Stats_linear_regression(x:=x_mismatch, y:=y_mismatch, result:=result_mismatch, eno=>result_eno);
		EXPECT_FALSE(result_eno);
	{end}
END_TEST_S

{#undef EPS}
