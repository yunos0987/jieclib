(*
 * $ cd <JiecLib Project Root>
 * $ jiecc ./test/stats/inference/effect_size/test_effect_size.txt -I. -I./vendor/jiecunit/sys -I./vendor/jiecunit -D_TEST_ -o ./test/stats/inference/effect_size/test_effect_size.xml -t omron
 *)
{#include <jiecunit.txt>}
{#include <stats/inference/effect_size/effect_size.txt>}

{#ifdef _TEST_}
DEFINE_CONFIGURATION(
	_JIEC_TESTNAMES_LIST_(
		'test_stats_hedges_g',
		'test_stats_cohens_d'
	)
)
{#endif}

{#define EPS 1.0e-9}

TEST_S(test_stats_hedges_g)
	var
		group1_c1: array[0..4] of lreal := [5.0, 5.0, 5.0, 5.0, 5.0];
		group2_c1: array[0..4] of lreal := [5.0, 5.0, 5.0, 5.0, 5.0];
		group1_c2: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		group2_c2: array[0..4] of lreal := [3.0, 4.0, 5.0, 6.0, 7.0];
		group1_c3: array[0..2] of lreal := [1.0, 2.0, 3.0];
		group2_c3: array[0..2] of lreal := [10.0, 11.0, 12.0];
		group1_c4: array[0..4] of lreal := [10.0, 11.0, 10.5, 11.5, 10.2];
		group2_c4: array[0..4] of lreal := [10.1, 11.1, 10.6, 11.6, 10.3];
		group1_c5: array[0..4] of lreal := [4.0, 5.0, 6.0, 4.5, 5.5];
		group2_c5: array[0..4] of lreal := [7.0, 8.0, 9.0, 7.5, 8.5];
		group1_c6: array[0..4] of lreal := [10.0, 12.0, 11.0, 10.5, 11.5];
		group2_c6: array[0..4] of lreal := [6.0, 8.0, 7.0, 6.5, 7.5];
		group1_c7: array[0..4] of lreal := [2.0, 3.0, 4.0, 2.0, 4.0];
		group2_c7: array[0..4] of lreal := [5.0, 6.0, 7.0, 5.0, 7.0];
		group1_c8: array[0..4] of lreal := [10.0, 10.02, 10.01, 10.03, 9.99];
		group2_c8: array[0..4] of lreal := [10.01, 10.03, 10.02, 10.04, 10.0];
		group1_c9: array[0..4] of lreal := [15.0, 16.0, 17.0, 15.5, 16.5];
		group2_c9: array[0..4] of lreal := [8.0, 9.0, 10.0, 8.5, 9.5];
		group1_c10: array[0..4] of lreal := [1.0, 1.0, 1.0, 2.0, 10.0];
		group2_c10: array[0..4] of lreal := [4.0, 4.0, 4.0, 5.0, 13.0];
		//
		result: lreal;
	end
	{st}
	// Case 1: Identical groups - should handle zero variance
	result := Stats_hedges_g(x:=group1_c1, y:=group2_c1);
	// Note: May return 0 or error depending on implementation
	EXPECT_TRUE(abs(result) < 1e-15 or result = 0.0);

	// Case 2: Different groups - group1 < group2, negative effect
	result := Stats_hedges_g(x:=group1_c2, y:=group2_c2);
	EXPECT_TRUE(result < -0.8 and result > -1.3);

	// Case 3: Large difference - mean1=2, mean2=11, negative effect
	result := Stats_hedges_g(x:=group1_c3, y:=group2_c3);
	EXPECT_TRUE(result < -4.0);

	// Case 4: Small difference - mean difference ~ 0.1, negative effect
	result := Stats_hedges_g(x:=group1_c4, y:=group2_c4);
	EXPECT_TRUE(result < 0.0 and result > -0.2);

	// Case 5: Moderate difference - mean1≈5, mean2≈8, negative effect
	result := Stats_hedges_g(x:=group1_c5, y:=group2_c5);
	EXPECT_TRUE(result < -1.0 and result > -4.0);

	// Case 6: Negative difference - group1 > group2
	result := Stats_hedges_g(x:=group1_c6, y:=group2_c6);
	EXPECT_TRUE(result > 1.5);

	// Case 7: Equal variance, different means, negative effect
	result := Stats_hedges_g(x:=group1_c7, y:=group2_c7);
	EXPECT_TRUE(result < -1.0);

	// Case 8: Very small effect, negative
	result := Stats_hedges_g(x:=group1_c8, y:=group2_c8);
	EXPECT_TRUE(result <= 0.0 and result > -0.7);

	// Case 9: Opposite sign effect
	result := Stats_hedges_g(x:=group1_c9, y:=group2_c9);
	EXPECT_TRUE(result > 3.0);

	// Case 10: Asymmetric distributions, negative effect
	result := Stats_hedges_g(x:=group1_c10, y:=group2_c10);
	EXPECT_TRUE(result < 0.0 and result > -1.0);
	{end}
END_TEST_S

TEST_S(test_stats_cohens_d)
	var
		group1_c1: array[0..4] of lreal := [1.0, 2.0, 3.0, 4.0, 5.0];
		group2_c1: array[0..4] of lreal := [3.0, 4.0, 5.0, 6.0, 7.0];
		group1_c2: array[0..4] of lreal := [5.0, 5.0, 5.0, 5.0, 5.0];
		group2_c2: array[0..4] of lreal := [5.0, 5.0, 5.0, 5.0, 5.0];
		group1_c3: array[0..4] of lreal := [1.0, 2.0, 3.0, 2.5, 1.5];
		group2_c3: array[0..4] of lreal := [8.0, 9.0, 10.0, 9.5, 8.5];
		group1_c4: array[0..3] of lreal := [5.0, 6.0, 5.5, 6.5];
		group2_c4: array[0..3] of lreal := [8.0, 9.0, 8.5, 9.5];
		group1_c5: array[0..4] of lreal := [10.0, 11.0, 10.5, 11.5, 10.2];
		group2_c5: array[0..4] of lreal := [11.0, 12.0, 11.5, 12.5, 11.2];
		group1_c6: array[0..4] of lreal := [5.0, 6.0, 7.0, 5.5, 6.5];
		group2_c6: array[0..4] of lreal := [10.0, 11.0, 12.0, 10.5, 11.5];
		group1_c7: array[0..4] of lreal := [0.0, 1.0, 2.0, 0.5, 1.5];
		group2_c7: array[0..4] of lreal := [20.0, 21.0, 22.0, 20.5, 21.5];
		group1_c8: array[0..4] of lreal := [3.0, 5.0, 2.0, 6.0, 4.0];
		group2_c8: array[0..4] of lreal := [3.0, 5.0, 2.0, 6.0, 4.0];
		group1_c9: array[0..4] of lreal := [8.0, 9.0, 10.0, 8.5, 9.5];
		group2_c9: array[0..4] of lreal := [5.0, 6.0, 7.0, 5.5, 6.5];
		group1_c10: array[0..4] of lreal := [100.0, 100.05, 100.02, 100.08, 99.95];
		group2_c10: array[0..4] of lreal := [100.03, 100.08, 100.05, 100.11, 99.98];
		//
		result: lreal;
	end
	{st}
	// Case 1: Basic - mean1=3.0, mean2=5.0, Cohen's d ≈ -1.265 (negative)
	result := Stats_cohens_d(x:=group1_c1, y:=group2_c1);
	EXPECT_NEAR(result, -1.264911064, EPS);

	// Case 2: Zero effect - identical groups (zero variance case)
	result := Stats_cohens_d(x:=group1_c2, y:=group2_c2);
	// Note: May return 0 or error depending on zero variance handling
	EXPECT_TRUE(abs(result) < EPS or result = 0.0);

	// Case 3: Large effect - mean1=2.0, mean2=9.0, Cohen's d < -3.0 (negative)
	result := Stats_cohens_d(x:=group1_c3, y:=group2_c3);
	EXPECT_TRUE(result < -3.0);

	// Case 4: Medium effect - mean1=5.75, mean2=8.75, diff=-3.0 (negative)
	result := Stats_cohens_d(x:=group1_c4, y:=group2_c4);
	EXPECT_TRUE(result < -1.0 and result > -5.0);

	// Case 5: Small negative effect
	result := Stats_cohens_d(x:=group1_c5, y:=group2_c5);
	EXPECT_TRUE(result < -0.4 and result > -2.0);

	// Case 6: Negative effect - group1 < group2
	result := Stats_cohens_d(x:=group1_c6, y:=group2_c6);
	EXPECT_TRUE(result < -1.0);

	// Case 7: Very large negative effect
	result := Stats_cohens_d(x:=group1_c7, y:=group2_c7);
	EXPECT_TRUE(result < -5.0);

	// Case 8: Equal groups with variance
	result := Stats_cohens_d(x:=group1_c8, y:=group2_c8);
	EXPECT_NEAR(result, 0.0, EPS);

	// Case 9: Moderate positive effect
	result := Stats_cohens_d(x:=group1_c9, y:=group2_c9);
	EXPECT_TRUE(result > 1.0 and result < 4.0);

	// Case 10: Tiny negative effect
	result := Stats_cohens_d(x:=group1_c10, y:=group2_c10);
	EXPECT_TRUE(result <= 0.0 and result > -1.0);
	{end}
END_TEST_S

{#undef EPS}
