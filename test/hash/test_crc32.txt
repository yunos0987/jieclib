(*
 * $ cd <JiecLib Project Root>
 * $ jiecc ./test/hash/test_crc32.txt -I. -I./src -I./vendor/jiecunit -I./vendor/jiecunit/sys -D_TEST_ -o ./test/hash/test_crc32.xml -t omron
 *)
{#include <jiecunit.txt>}
{#include <test/hash/helper_random.txt>}

{#include <hash/crc32.txt>}

{#ifdef _TEST_}
DEFINE_CONFIGURATION(
	_JIEC_TESTNAMES_LIST_(
		'test_CRC32_string',
		'test_CRC32_bytes'
	)
)
{#endif}

TEST_S(test_CRC32_string)
	var
		r: string[8 + 1];
		o: bool;
		work: array[0..4095] of byte;
		work_exact: array[0..2] of byte;
		work_small: array[0..1] of byte;
	end
	{st}
	r := CRC32_string(txt:='', work:=work);
	EXPECT_EQ_STRING('00000000', r);

	r := CRC32_string(txt:='abc', work:=work);
	EXPECT_EQ_STRING('352441c2', r);
	r := CRC32_string(txt:='abc', work:=work_exact);
	EXPECT_EQ_STRING('352441c2', r);

	r := CRC32_string(txt:='hello world', work:=work);
	EXPECT_EQ_STRING('0d4a1185', r);

	r := CRC32_string(txt:='123456789', work:=work);
	EXPECT_EQ_STRING('cbf43926', r);

	r := CRC32_string(txt:='$09$0A$0D', work:=work);
	EXPECT_EQ_STRING('74ce76aa', r);
	r := CRC32_string(txt:='fyPoFC21J5SX', work:=work);
	EXPECT_EQ_STRING('6ed670a1', r);
	r := CRC32_string(txt:='lBvqPXf8e0aO5C9', work:=work);
	EXPECT_EQ_STRING('623dd8cc', r);
	r := CRC32_string(txt:='$7F', work:=work);
	EXPECT_EQ_STRING('12b88320', r);

	r := CRC32_string(txt:='!@#$$%^&*()_+-=[]{}|;$':",./<>?`~', work:=work);
	EXPECT_EQ_STRING('007e64ee', r);

	CRC32_string(txt:='$E3$81$82', work:=work, eno=>o);
	EXPECT_FALSE(o);
	CRC32_string(txt:='abc', work:=work_small, eno=>o);
	EXPECT_FALSE(o);
	{end}
END_TEST_S

TEST_S(test_CRC32_bytes)
	var
		r: string[8 + 1];
		o: bool;
		work: array[0..4095] of byte;
		d0: array[0..0] of byte := [byte#16#00];
		d1: array[0..2] of byte := [byte#16#00, byte#16#01, byte#16#02];
		d2: array[0..5] of byte := [byte#16#41, byte#16#42, byte#16#43, byte#16#78, byte#16#79, byte#16#7A];
		d3: array[0..6] of byte := [byte#16#00, byte#16#09, byte#16#0A, byte#16#0D, byte#16#7F, byte#16#80, byte#16#FF];
		d4: array[0..5] of byte := [byte#16#10, byte#16#20, byte#16#30, byte#16#40, byte#16#50, byte#16#60];
		rb1: array[0..8] of byte := [byte#16#97, byte#16#F1, byte#16#E2, byte#16#58, byte#16#EE, byte#16#19, byte#16#D9, byte#16#18, byte#16#C8];
		rb2: array[0..12] of byte := [byte#16#2A, byte#16#41, byte#16#0D, byte#16#52, byte#16#94, byte#16#C2, byte#16#AF, byte#16#89, byte#16#0F, byte#16#CB, byte#16#B8, byte#16#8E, byte#16#D5];
		rb1000: array[0..999] of byte := TEST_HASH_RB1000_LITERAL();
	end
	{st}
	r := CRC32_bytes(dat:=d0, length:=0, work:=work);
	EXPECT_EQ_STRING('00000000', r);

	r := CRC32_bytes(dat:=d0, length:=1, work:=work);
	EXPECT_EQ_STRING('d202ef8d', r);

	r := CRC32_bytes(dat:=d1, work:=work);
	EXPECT_EQ_STRING('0854897f', r);

	r := CRC32_bytes(dat:=d2, work:=work);
	EXPECT_EQ_STRING('ca9be7e5', r);

	r := CRC32_bytes(dat:=d3, work:=work);
	EXPECT_EQ_STRING('4b951661', r);
	r := CRC32_bytes(dat:=rb1, work:=work);
	EXPECT_EQ_STRING('20d7afe6', r);
	r := CRC32_bytes(dat:=rb2, work:=work);
	EXPECT_EQ_STRING('c7a8fcb3', r);
	r := CRC32_bytes(dat:=rb1000, work:=work);
	EXPECT_EQ_STRING('cc577bab', r);
	r := CRC32_bytes(dat:=rb1000, offset:=0, length:=1000, work:=work);
	EXPECT_EQ_STRING('cc577bab', r);

	r := CRC32_bytes(dat:=d4, offset:=0, length:=5, work:=work);
	EXPECT_EQ_STRING('b98934c0', r);

	r := CRC32_bytes(dat:=d4, offset:=1, length:=3, work:=work);
	EXPECT_EQ_STRING('6e96e891', r);
	r := CRC32_bytes(dat:=d4, offset:=1, length:=-1, work:=work);
	EXPECT_EQ_STRING('705b9174', r);
	r := CRC32_bytes(dat:=d4, offset:=6, length:=0, work:=work);
	EXPECT_EQ_STRING('00000000', r);

	CRC32_bytes(dat:=d4, offset:=-1, length:=1, work:=work, eno=>o);
	EXPECT_FALSE(o);
	CRC32_bytes(dat:=d4, offset:=0, length:=-2, work:=work, eno=>o);
	EXPECT_FALSE(o);
	CRC32_bytes(dat:=d4, offset:=6, length:=1, work:=work, eno=>o);
	EXPECT_FALSE(o);
	CRC32_bytes(dat:=d1, work:=d0, eno=>o);
	EXPECT_FALSE(o);
	{end}
END_TEST_S
